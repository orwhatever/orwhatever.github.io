<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>Title</title>

<script id="vertex-shader" type="x-shader/x-vertex">
precision mediump float;

attribute  vec4 vPosition;
attribute  vec3 vNormal;

uniform vec3 eye;
varying vec3 incidence;

varying vec3 fNorm;	
uniform mat4 modelView;
uniform mat4 projection;
uniform mat4 mTex;

varying vec3 lookup;

void main()
{
	fNorm = vNormal;
    gl_Position = projection*modelView*vPosition;
	lookup = (mTex*vPosition).xyz;
	incidence = vPosition.xyz-eye;
}
</script>

<script id="fragment-shader" type="x-shader/x-fragment">
precision mediump float;

varying vec3 fNorm;
varying vec4 texCoord;


varying vec3 incidence;
uniform int mirror;
uniform samplerCube texMap;
uniform sampler2D normalMap;

varying vec3 lookup;

float atan2(float y, float x) { return 2.0*atan((length(vec2(x, y)) - x)/y); }

vec3 rotate_to_normal(vec3 normal, vec3 v)
{
	float a = 1.0/(1.0 / normal.z);
	float b = -normal.x*normal.y*a;
	return 	vec3(1.0 - normal.x*normal.x*a, b, -normal.x)*v.x +
			vec3(b, 1.0 - normal.y*normal.y*a, -normal.y)*v.y +
			normal*v.z;
}

void
main()
{
	float pi = acos(0.0);
	float s, t;
	vec3 n = normalize(fNorm);
	vec3 reflected;
	vec3 i = (incidence);
	if(mirror == 1)
	{
		reflected = reflect(i,n);
		s = 0.5 + atan2(n.z,n.x)/(4.0*pi);
		t = 0.5 - asin(n.y)/(2.0*pi);
		vec4 tangent = texture2D( normalMap, vec2(s, t));
		reflected = rotate_to_normal(n,tangent.xyz);
	}
	else
	{
		reflected = lookup;
	}
	vec4 texColor = textureCube(texMap, reflected);
	gl_FragColor = texColor;
}
</script>

<script type="text/javascript" src="Common/webgl-utils.js"></script>
<script type="text/javascript" src="Common/initShaders.js"></script>
<script type="text/javascript" src="Common/MV.js"></script>
<script type="text/javascript" src="worksheet10v1.js"></script>
</head>

<body>
<canvas id="gl-canvas" width="512" height="512">
Oops ... your browser doesn't support the HTML5 canvas element
</canvas>
</body>
</html>
